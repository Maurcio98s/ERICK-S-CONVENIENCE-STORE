name: Python Code Quality and Security Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Search for Python files
        id: find_files
        run: |
          echo "Buscando archivos Python..."
          PY_FILES=$(find . -type f -name "*.py")
          if [ -z "$PY_FILES" ]; then
            echo "❌ No se encontraron archivos Python. Terminando flujo."
            exit 1
          fi
          echo "✅ Archivos encontrados:"
          echo "$PY_FILES"
          echo "py_files=$PY_FILES" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 flake8-html safety

      - name: Run Flake8 (Code Style)
        run: |
          echo "Ejecutando análisis de estilo con Flake8..."
          mkdir -p flake8_report
          # Ejecutar sobre todos los .py encontrados
          flake8 $(find . -type f -name "*.py") --exit-zero --format=html --htmldir=flake8_report
          echo "✅ Análisis de estilo completado. Resultados guardados en flake8_report/"

      - name: Run Safety (Dependency Security)
        run: |
          echo "Ejecutando análisis de seguridad con Safety..."
          if [ -f "requirements.txt" ]; then
            safety check --file=requirements.txt --full-report > safety_report.txt
          else
            echo "⚠️ No se encontró requirements.txt. Saltando revisión de dependencias." > safety_report.txt
          fi
          echo "✅ Revisión de seguridad completada. Informe guardado en safety_report.txt"

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: code_quality_reports
          path: |
            flake8_report/
            safety_report.txt
